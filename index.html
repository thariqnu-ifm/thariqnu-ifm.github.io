<html>
	<div>
		<span id="dbg">H1</span>
	</div>
	<textarea id="zz" autocapitalize="none" autocomplete="on" autofocus="true" 
		  placeholder="Start writing here" spellcheck="false" cols="30" rows="30"></textarea>
	<script type="text/javascript">
var zz = document.getElementById('zz');
var downContent = zz.value = localStorage.getItem('a') || '';
zz.onkeydown = function(e) {
  downContent = zz.value;
  if (e.key == 'Enter' || e.which == 13) {
    setTimeout(function(that) {
      var start = that.selectionStart;
      if (start == 0) return;
      var v = that.value;
      var thisLine = '';
      for (var i = start - 2; i >= 0 && v[i] != '\n'; i--) {
        thisLine = v[i] + thisLine;
      }
      var indentation = thisLine.substring(0, thisLine.length - thisLine.trimLeft().length);
      var tail = thisLine.trimRight().slice(-1);
      if (':{(['.indexOf(tail) > -1)
        indentation += '\t';
      that.value = (v.slice(0, start) + indentation + v.slice(start));
      that.selectionStart = that.selectionEnd = start + indentation.length;
    }, 0.01, this);
  }
};

function save() {
  setTimeout(function() {
    localStorage.setItem('a', zz.value);
    save();
  }, 30 * 1000);
}
save();
var pairs = {
  '(': ')',
  '{': '}',
  '[': ']'
};
zz.onkeyup = function(kb) {
  var content = zz.value;
  if (content.length <= downContent.length) return;
  var ix = zz.selectionStart;
  if (ix == 0) return;
  var chr = content[ix - 1];
  var add = pairs[chr];
  if (add) {
    zz.value = content.slice(0, ix) + add + content.slice(ix);
    zz.selectionStart = zz.selectionEnd = ix;
  } else if (chr == ' ' && ix > 1 && ix < content.length && pairs[content[ix - 2]] == content[ix]) {
    zz.value = content.slice(0, ix - 1) + content.slice(ix);
    zz.selectionStart = zz.selectionEnd = ix;
  }
  downContent = zz.value;
}
	</script>
</html>
